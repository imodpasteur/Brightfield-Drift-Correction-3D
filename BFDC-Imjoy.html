
<docs lang="markdown">
You need to install Python Engine first https://github.com/oeway/ImJoy-Python	
Then create a new plugin and paste this code to it.	
The plugin will configure Python automatically with all dependencies.	
Click on the BFDC to run the plugin.	
You'll see the file dialog to select zstack, roi and movie.	
Then the plugin will launch Python package to process the files and output the drift table.	
It will also show the drift plot in the separate window.
</docs>

<config lang="json">
{
  "name": "BFDC",
  "mode": "pyworker",
  "version": "0.1.0",
  "api_version": "0.1.1",
  "description": "A plugin for demonstrate python plugin.",
  "tags": ["Generic", "ZOLA-scope", "Basement Scope"],
  "ui": "Ops for tracing, applying and batch processing bright field drift. Select your operation type and check the parameters.",
  "inputs": null,
  "outputs": null,
  "icon": null,
  "env": "conda create -n imjoy python=3.7",
  "requirements": [git+https://github.com/imodpasteur/Brightfield-Drift-Correction-3D.git],
  "dependencies": []
}
</config>

<script lang="python">
import numpy as np
import sys
import os
#sys.path.insert(0,'/Volumes/Imod-grenier/Andrey/Phase retrieve/drift-correction/BFDC/')
from bfdc import drift
import base64

class PythonPlugin():
  def setup(self):
    print(f'Running BFDC in Python {sys.version}.')
    
    #self.root=None
    #api.setConfig('root',None)
    api.getConfig('root').then(self.config_root)
    
    #self.root = '/Volumes/Imod-grenier/Andrey/Phase retrieve/drift-correction/BFDC/data/full_frame/'
    #self.root = '/Volumes/Imod-grenier/Mickael/yeast_imaging_EdU/20180709-yeastimaging-01micronEDU-9generation/20180709-yeastimaging-01micronEDU-9generation/bigbeads_yeastimaging/vutara_w_bMEA10mM_cot10mM/beadscalibration2/'
    
    if api.TAG == 'ZOLA-scope':
        self.px = 110
        self.zstep = 100
        self.minsig = 100
    elif api.TAG == 'Basement Scope':
        self.px = 76
        self.zstep = 50
        self.minsig = 0
    elif api.TAG == 'Generic':
        self.px = 100
        self.zstep = 100
        self.minsig = 0
    else:
        self.px = None
        self.zstep = None
        raise AttributeError('Unsupported TAG')
    self.smooth = 0
    self.skip = 0
    api.register({"name": "trace", 
                    "ui": ["pixel size (nm): {id: 'px', type: 'number', min: 0, placeholder:%d}"%self.px, 
                            "z step (nm): {id: 'zstep', type: 'number', min: 0, placeholder:%d}"%self.zstep,
                            "skip frames : {id: 'skip', type: 'number', min: 0, placeholder:%d}"%self.skip,
                            "mininal signal for the frame to be treated as brightfield: {id: 'minsig', type: 'number', min: 0, placeholder:%d}"%self.minsig]})
    api.register({"name": "apply", 
                    "ui": "smooth (timepoints): {id: 'smooth', type: 'number', min: 0, placeholder:%d}"%self.smooth})
    
  def show_config(self,args):
    print(f'Root directory is set to : {self.root}')
    print(f'Current TAG is {api.TAG}')
    api.showProgress(0)

  def config_root(self,root):
    print(f'found getConfig.root {root}')
    sys.stdout.flush()
    api.showStatus(f'Found root path: {root}')
    if root == "null" or not os.path.isdir(root):
        api.showDialog({"name": "Configure start folder",
                          "ui": "Please type in the path to start with: {id:'path', type:'string', placeholder: '%s'}."%root}).then(self.set_root)
    else:
        self.root = root
        self.show_config(root)

  def set_root(self,path):
    api.showStatus(f'Selected {path.path} from the dialog')
    path = path.path
    try:
        os.path.isdir(path)
    except:
        path = r'%s'%path
    if os.path.isdir(path):
        self.root = path
        api.setConfig('root', path)
        self.show_config(None)
    else:
        api.alert('Suggerted path is wrong, try again')
        self.config_root()
    return

  def open_z_stack(self, path):
    self.z_stack_path = path
    print(f'Z stack selected {path}')
    new_path = os.path.dirname(path)
    api.showFileDialog(title='Select ROI', root=new_path).then(self.open_ROI)
    

  def open_ROI(self, path):
    self.ROI_path = path
    new_path = os.path.dirname(path)
    api.showFileDialog(title='Select movie', root=new_path).then(self.open_movie)
    #print(f'Showing file dialog {new_path}')

  def open_movie(self, path):
    self.movie_path = path
    self.analyse_drift()

  def analyse_drift(self):
    args = ["trace", 
            self.z_stack_path, 
            self.ROI_path, 
            self.movie_path, 
            f"--xypixel={self.px}", 
            f"--zstep={self.zstep}", 
            f"--minsignal={self.minsig}",
            f"--skip={self.skip}"]
    
    print(f'Args list: {args}')
    sys.stdout.flush()
    drift.main(argsv=args, callback=self.show_progress)
    self.show_drift_plot()
    api.setConfig('root',os.path.dirname(self.movie_path))
  
  def show_drift_plot(self):
    with open(os.path.join(os.path.dirname(self.movie_path),'BFCC_table_2zero.png'), 'rb') as f:
        data = f.read()
        result = base64.b64encode(data).decode('ascii')
        imgurl = 'data:image/png;base64,' + result
        api.createWindow(name='Drift prediction', type = 'imjoy/image', w=5, h=5, data= {"src": imgurl})


  def run(self, my):
    print('<===== Start BFDC =====>')

    def trace(config):
        self.px = config.px
        self.zstep = config.zstep
        self.skip = config.skip
        if os.path.exists(self.root):
            api.showFileDialog(title='Select z stack', root=self.root).then(self.open_z_stack)
        else:
            self.config_root()
    if my.config.type not in ['trace', 'apply']:
        api.alert("BFDC is a set of tools for tracing, applying and batch processing the drift from the bright field. Please, select your operation type from drop-down menu and check the parameters")
    else:
        trace(my.config)

  def show_progress(self, msg):
    assert isinstance(msg,dict)
    current, total, found = msg.values()
    if current%1 == 0:
        api.showStatus(f'Processing {current}/{total}, found {found} BF frames')
        api.showProgress(int(current / total * 100))

api.export(PythonPlugin())
</script>

